let charges = 3;
const API_URL = 'http://159.69.28.25:5000/calculate';

function calculateIncome() {
    if (charges <= 0) {
        document.getElementById('noBatteriesPanel').style.display = 'block';
        document.body.classList.add('no-scroll', 'no-click');
        return;
    }

    const power = document.getElementById('powerInput').value;
    if (!power || power <= 0) {
        alert('Please enter a valid power value.');
        return;
    }

    const calculateButton = document.querySelector('button[onclick="calculateIncome()"]');
    calculateButton.disabled = true;

    const rows = document.querySelectorAll('#result table tr');
    rows.forEach((row, index) => {
        if (index > 0) {
            row.cells[1].innerHTML = '<span class="loading-amount"></span>';
        }
    });

    const xhr = new XMLHttpRequest();
    xhr.open('POST', API_URL, true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.message) {
                    const rewards = response.message.split('\n').map(line => line.split(': '));
                    rewards.forEach((reward, index) => {
                        if (rows[index + 1]) {
                            rows[index + 1].cells[1].innerHTML = reward[1];
                        }
                    });
                    charges--;
                    updateProgressBar();
                }
            } catch (e) {
                console.error('Error parsing response:', e);
                alert('Error calculating rewards. Please try again.');
            }
        } else {
            console.error('Server error:', xhr.status);
            alert('Error calculating rewards. Please try again.');
        }
        calculateButton.disabled = false;
        rows.forEach((row, index) => {
            if (index > 0 && row.cells[1].innerHTML.includes('loading-amount')) {
                row.cells[1].innerHTML = '0';
            }
        });
    };

    xhr.onerror = function() {
        console.error('Network error occurred');
        alert('Network error. Please check your connection and try again.');
        calculateButton.disabled = false;
        rows.forEach((row, index) => {
            if (index > 0) {
                row.cells[1].innerHTML = '0';
            }
        });
    };

    xhr.send(JSON.stringify({ power: parseInt(power) }));
}
