<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RollerCoin Calculator</title>
    <style>
        /* استایل‌های قبلی بدون تغییر */
    </style>
</head>
<body>
    <!-- HTML بدون تغییر -->
    <script>
        let charges = 3;
        // استفاده از CORS proxy
        const BASE_URL = 'http://159.69.28.25:5000/calculate';
        const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(BASE_URL);

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const percentage = (charges / 3) * 100;
            progressBar.style.width = `${percentage}%`;
            if (charges <= 0) {
                progressBar.style.background = 'linear-gradient(to right, #555, #000)';
                progressBar.classList.add('no-charging');
            } else {
                progressBar.style.background = 'linear-gradient(to right, #00ff00, #006400)';
                progressBar.classList.remove('no-charging');
            }
        }

        function calculateIncome() {
            if (charges <= 0) {
                document.getElementById('noBatteriesPanel').style.display = 'block';
                document.body.classList.add('no-scroll', 'no-click');
                return;
            }

            const power = document.getElementById('powerInput').value;
            if (!power || power <= 0) {
                alert('Please enter a valid power value.');
                return;
            }

            const calculateButton = document.querySelector('button[onclick="calculateIncome()"]');
            calculateButton.disabled = true;

            const rows = document.querySelectorAll('#result table tr');
            rows.forEach((row, index) => {
                if (index > 0) {
                    row.cells[1].innerHTML = '<span class="loading-amount"></span>';
                }
            });

            fetch(PROXY_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ power: parseInt(power) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    const rewards = data.message.split('\n').map(line => line.split(': '));
                    rewards.forEach((reward, index) => {
                        if (rows[index + 1]) {
                            rows[index + 1].cells[1].innerHTML = reward[1];
                        }
                    });
                    charges--;
                    updateProgressBar();
                } else if (data.error) {
                    throw new Error(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to calculate. Please try again later.');
                rows.forEach((row, index) => {
                    if (index > 0) {
                        row.cells[1].innerHTML = '0';
                    }
                });
            })
            .finally(() => {
                calculateButton.disabled = false;
            });
        }

        function getFreeBatteries() {
            charges = 3;
            updateProgressBar();
            closePanel();
        }

        function closePanel() {
            document.getElementById('noBatteriesPanel').style.display = 'none';
            document.body.classList.remove('no-scroll', 'no-click');
        }

        updateProgressBar();
    </script>
</body>
</html>
